[gcode_macro END_PRINT]
gcode:
 {% set BED_X_MAX = printer.toolhead.axis_maximum.x %}
 {% set BED_Y_MAX = printer.toolhead.axis_maximum.y %}
 {% set BED_Z_MAX = printer.toolhead.axis_maximum.z %}
 M140 S0 # Turn off bed, extruder, and fan
 M104 S0
 M106 S0
 G91 # relative positioning
 G1 Z10 F4000 # Raise nozzle by 10mm
 G1 E-2 F300 # Retract filament
 G90 # absolute positioning
 G1 Z{BED_Z_MAX * 0.9 } F1200 # Move carriage to z-max*0.9, present bed
 M84 # Disable steppers